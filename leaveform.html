<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Leave Management System</title>
<style>
    :root {
        --primary: #4f46e5;
        --primary-hover: #4338ca;
        --bg-body: #f3f4f6;
        --bg-card: #ffffff;
        --text-main: #1f2937;
        --text-muted: #6b7280;
        --border: #e5e7eb;
        --danger: #ef4444;
        --success: #10b981;
        --warning: #f59e0b;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    * { box-sizing: border-box; outline: none; }

    body {
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
        line-height: 1.5;
        transition: background 0.3s;
    }

    .container {
        max-width: 1100px; 
        margin: 0 auto;
        background-color: var(--bg-card);
        padding: 30px;
        border-radius: 12px;
        box-shadow: var(--shadow);
        transition: background-color 0.3s;
        display: block; /* Changed to block so it shows immediately */
        opacity: 1;
    }

    /* Header Styling */
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
        gap: 10px;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .main-title {
        font-size: 20px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .record-count {
        background: var(--primary);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: bold;
    }

    .header-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .search-box input {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        width: 220px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    .search-box input:focus {
        border-color: var(--primary);
    }

    /* Buttons & Color Picker */
    .icon-btn {
        background: white;
        border: 1px solid var(--border);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: transform 0.2s;
        position: relative;
    }
    .icon-btn:hover { transform: scale(1.1); }
    #colorInput { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

    /* Form Grid */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .form-group { display: flex; flex-direction: column; }

    label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    input, select {
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        background: #fff;
        transition: all 0.2s;
        width: 100%;
    }

    input:focus, select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        filter: invert(40%);
        margin-left: 5px;
    }

    /* Action Bars */
    .actions-bar { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .utility-bar { display: flex; gap: 10px; margin-bottom: 30px; justify-content: flex-end; }

    button {
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 600;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s, transform 0.1s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }
    button:active { transform: scale(0.98); }

    .btn-save { background: var(--primary); color: white; flex: 2; }
    .btn-save:hover { background: var(--primary-hover); }

    .btn-download { background: var(--text-main); color: white; flex: 1; }
    .btn-download:hover { background: #000; }

    .btn-backup { background: var(--warning); color: white; font-size: 12px; padding: 8px 12px; }
    .btn-restore { background: var(--success); color: white; font-size: 12px; padding: 8px 12px; }

    /* Table */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }

    thead th {
        text-align: left;
        padding: 12px 15px;
        background-color: rgba(0,0,0,0.05);
        color: var(--text-muted);
        font-weight: 600;
        border-bottom: 2px solid var(--border);
        white-space: nowrap;
    }

    tbody td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
    }

    tbody tr:hover { background-color: rgba(0,0,0,0.02); }

    /* Badges */
    .badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }
    .badge-full { background: #d1fae5; color: #065f46; }
    .badge-half { background: #ffedd5; color: #9a3412; }

    /* Action Buttons in Table */
    .action-btn { padding: 4px 8px; font-size: 12px; margin-right: 5px; width: auto; }
    .btn-edit { background: var(--warning); color: white; }
    .btn-edit:hover { background: #d97706; }
    .btn-del { background: var(--danger); color: white; }
    .btn-del:hover { background: #dc2626; }

    /* Toast */
    #toast {
        visibility: hidden;
        min-width: 250px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 4px;
        padding: 12px;
        position: fixed;
        z-index: 1000;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-size: 14px;
        opacity: 0;
        transition: opacity 0.3s, bottom 0.3s;
    }
    #toast.show { visibility: visible; opacity: 1; bottom: 50px; }

    /* Print Styles */
    @media print {
        body { background: white; padding: 0; }
        .container { box-shadow: none; max-width: 100%; padding: 0; }
        .actions-bar, .utility-bar, .search-box, .header-controls, #toast { display: none !important; }
        table { font-size: 12px; width: 100%; }
        th, td { border: 1px solid #000; padding: 5px; }
    }

    @media (max-width: 600px) {
        .header { flex-direction: column; align-items: flex-start; gap: 10px; }
        .header-controls { width: 100%; flex-direction: column-reverse; align-items: stretch; }
        .search-box input { width: 100%; }
        .actions-bar, .utility-bar { flex-direction: column; }
        .icon-btn { align-self: flex-end; margin-bottom: -50px; z-index: 10; }
    }
</style>
</head>
<body>

<div class="container" id="app-container">
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="main-title">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                Leave Management
                <span class="record-count" id="recordCount">0</span>
            </div>
        </div>
        
        <div class="header-controls">
            <div class="search-box">
                <input id="search" type="text" placeholder="Search employee name..." oninput="loadData()">
            </div>
            
            <div class="icon-btn" title="Change Card Color">
                ðŸŽ¨
                <input type="color" id="colorInput" oninput="changeColor(this.value)">
            </div>
        </div>
    </div>

    <!-- Form Area -->
    <div class="form-grid">
        <div class="form-group">
            <label>Employee Name</label>
            <input id="name" type="text" placeholder="e.g. John Doe" autocomplete="off">
        </div>

        <div class="form-group">
            <label>Section / Department</label>
            <input id="section" type="text" placeholder="e.g. Sales" autocomplete="off">
        </div>

        <div class="form-group">
            <label>Leave Type</label>
            <select id="type">
                <option value="Full Day">Full Day</option>
                <option value="Half Day">Half Day</option>
            </select>
        </div>

        <div class="form-group">
            <label>Leave From</label>
            <input id="from" type="text" class="smart-date" placeholder="DD-MM-YYYY" maxlength="10" oninput="formatDate(this, 'to')" autocomplete="off">
        </div>

        <div class="form-group">
            <label>Leave To</label>
            <input id="to" type="text" class="smart-date" placeholder="DD-MM-YYYY" maxlength="10" oninput="formatDate(this)" autocomplete="off">
        </div>

        <div class="form-group">
            <label>Date Submitted</label>
            <input id="submitted" type="date">
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="actions-bar">
        <button class="btn-save" onclick="save()">
            <span id="saveText">Save Record</span>
        </button>
        <button class="btn-download" onclick="download()">
            <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Download Report
        </button>
    </div>

    <!-- Utility Buttons (Backup) -->
    <div class="utility-bar">
        <button class="btn-backup" onclick="backupData()">ðŸ’¾ Backup Data (Save File)</button>
        <button class="btn-restore" onclick="triggerRestore()">ðŸ“‚ Restore Data (Load File)</button>
        <input type="file" id="fileInput" style="display:none" onchange="restoreData(this)">
    </div>

    <!-- Data Table -->
    <div class="table-container">
        <table id="log">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Section</th>
                    <th>Type</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Date Submitted</th>
                    <th style="text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- Toast Message -->
<div id="toast">Operation Successful</div>

<script>
    // --- GLOBAL VARIABLES ---
    let editIndex = -1;

    // --- INITIALIZATION ---
    window.onload = () => {
        loadData();
        get("submitted").valueAsDate = new Date();
    };

    // --- APP LOGIC ---

    function changeColor(color) {
        document.querySelector('.container').style.backgroundColor = color;
    }

    function formatDate(input, nextFieldId) {
        let value = input.value;
        let raw = value.replace(/\D/g, '');
        let today = new Date();
        let defaultMonth = String(today.getMonth() + 1).padStart(2, '0');
        let defaultYear = String(today.getFullYear());

        if (raw.length === 2 && value.length <= 2) {
             input.value = raw + "-" + defaultMonth + "-" + defaultYear;
             return;
        }

        if (value.length > 10) {
            input.value = value.slice(0, 10);
            return;
        }

        if (raw.length > 2) {
             let d = raw.slice(0, 2);
             let m = raw.slice(2, 4);
             let y = raw.slice(4, 8);
             
             let formatted = d;
             if (m) formatted += "-" + m;
             if (y) formatted += "-" + y;
             
             input.value = formatted;
        }
    }

    function save() {
        let name = get("name").value.trim();
        let section = get("section").value.trim();
        let type = get("type").value;
        let from = get("from").value;
        let to = get("to").value;
        let submitted = get("submitted").value;

        let fromISO = parseCustomDate(from);
        let toISO = parseCustomDate(to);
        let subISO = submitted; 

        if (!name || !fromISO || !toISO || !subISO) {
            showToast("Please fill in all required fields.");
            return;
        }

        if (new Date(fromISO) > new Date(toISO)) {
            showToast("'From Date' cannot be after 'To Date'.");
            return;
        }

        let data = getData();
        let record = { name, section, type, from: fromISO, to: toISO, submitted: subISO };

        if (editIndex === -1) {
            data.push(record);
            showToast("Leave recorded successfully!");
        } else {
            data[editIndex] = record;
            editIndex = -1;
            document.getElementById("saveText").innerText = "Save Record";
            showToast("Record updated successfully!");
        }

        setData(data);
        clearForm();
        loadData();
        get("name").focus();
    }

    function edit(i) {
        let data = getData();
        let r = data[i];
        get("name").value = r.name;
        get("section").value = r.section;
        get("type").value = r.type;
        get("from").value = reverseParseDate(r.from);
        get("to").value = reverseParseDate(r.to);
        get("submitted").value = r.submitted; 

        editIndex = i;
        document.getElementById("saveText").innerText = "Update Record";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function del(i) {
        if (!confirm("Are you sure you want to delete this record?")) return;
        let data = getData();
        data.splice(i, 1);
        setData(data);
        
        if (editIndex === i) {
            clearForm();
            editIndex = -1;
            document.getElementById("saveText").innerText = "Save Record";
        } else if (editIndex > i) {
            editIndex--;
        }
        loadData();
        showToast("Record deleted.");
    }

    function loadData() {
        let data = getData();
        document.getElementById('recordCount').innerText = data.length;
        
        let search = get("search").value.toLowerCase();
        let tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:var(--text-muted); padding:30px;">No records found.</td></tr>`;
            return;
        }

        let count = 0;
        data.forEach((r, i) => {
            if (!r.name.toLowerCase().includes(search)) return;

            let row = tbody.insertRow(-1);
            let badgeClass = r.type === "Full Day" ? "badge-full" : "badge-half";
            
            row.innerHTML = `
                <td><strong>${r.name}</strong></td>
                <td>${r.section}</td>
                <td><span class="badge ${badgeClass}">${r.type}</span></td>
                <td>${formatDateDisplay(r.from)}</td>
                <td>${formatDateDisplay(r.to)}</td>
                <td>${formatDateDisplay(r.submitted)}</td>
                <td style="text-align: right;">
                    <button class="action-btn btn-edit" onclick="edit(${i})">Edit</button>
                    <button class="action-btn btn-del" onclick="del(${i})">Delete</button>
                </td>
            `;
            count++;
        });

        if(count === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:var(--text-muted); padding:30px;">No matching records found.</td></tr>`;
        }
    }

    function download() {
        let data = getData();
        if (data.length === 0) { showToast("No data to download."); return; }

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Name,Section,Type,From,To,Date Submitted\n";

        data.forEach(r => {
            let row = `"${r.name}","${r.section}","${r.type}","${formatDateDisplay(r.from)}","${formatDateDisplay(r.to)}","${formatDateDisplay(r.submitted)}"`;
            csvContent += row + "\n";
        });

        let encodedUri = encodeURI(csvContent);
        let link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Leave_Report_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function backupData() {
        let data = getData();
        let dataStr = JSON.stringify(data);
        let blob = new Blob([dataStr], {type: "application/json"});
        let url = URL.createObjectURL(blob);
        let link = document.createElement("a");
        link.href = url;
        link.download = "leave_backup_" + new Date().toISOString().slice(0,10) + ".json";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function triggerRestore() {
        document.getElementById('fileInput').click();
    }

    function restoreData(input) {
        let file = input.files[0];
        if(!file) return;

        let reader = new FileReader();
        reader.onload = function(e) {
            try {
                let data = JSON.parse(e.target.result);
                if(Array.isArray(data)) {
                    setData(data);
                    loadData();
                    showToast("Database Restored Successfully!");
                } else {
                    alert("Invalid file format.");
                }
            } catch(err) {
                alert("Error reading file.");
            }
        };
        reader.readAsText(file);
    }

    function parseCustomDate(dateStr) {
        if (!dateStr || dateStr.length < 8) return null;
        let parts = dateStr.split('-');
        if (parts.length !== 3) return null;
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }

    function reverseParseDate(isoStr) {
        if(!isoStr) return "";
        let parts = isoStr.split('-'); 
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }

    function clearForm() {
        get("name").value = "";
        get("section").value = "";
        get("type").value = "Full Day";
        get("from").value = "";
        get("to").value = "";
        get("submitted").valueAsDate = new Date();
        editIndex = -1;
        document.getElementById("saveText").innerText = "Save Record";
    }

    function get(id) { return document.getElementById(id); }

    function formatDateDisplay(dateString) {
        if(!dateString) return "";
        let options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
    }

    function getData() { return JSON.parse(localStorage.getItem("leaveData")) || []; }
    function setData(d) { localStorage.setItem("leaveData", JSON.stringify(d)); }

    function showToast(message) {
        let x = document.getElementById("toast");
        x.textContent = message;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }
</script>

</body>
</html>